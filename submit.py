import os
import requests
from tqdm import tqdm 
import json


REST_URL = "http://localhost:8090/tasks/create/file"
FILE_PATH = "/home/zero/Documents/HW1/virushare-20/PEs/"
HEADERS = {"Authorization": "Bearer mW54f6-LeqmcCfNRK0nZ0w"}

allfolder = os.listdir(FILE_PATH)
allFiles = []
allTaskId = []
for index, folder in enumerate(allfolder):
    allfolder[index] = FILE_PATH  + folder

for folder in allfolder:
    for filename in os.listdir(folder):
        allFiles.append(folder + '/' + filename)

file_info=[]

for filename in tqdm(allFiles):
    label = filename.split('/')[-2]
    name = filename.split('/')[-1]
    with open(filename, "rb") as sample:
        file = {"file":(name,sample)}
        r = requests.post(REST_URL, headers=HEADERS, files=file)
    task_id = r.json()["task_id"]
    info = {"task_id":task_id, "label":label, "filename":name}
    
    with open('./FileInfo/' + name + ".json", 'w') as file:
        json.dump(info, file, indent=4)

