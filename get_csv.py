import json
import csv
import os
from tqdm import tqdm

FOLDER_PATH = '/home/zero/Documents/HW1/virusReport/'
for folders in tqdm(os.listdir(FOLDER_PATH)):
    folder = os.path.join(FOLDER_PATH, folders)  # Use os.path.join for better path handling
    for files in tqdm(os.listdir(folder),leave=False):
        file_path = os.path.join(folder, files)  # Full path to the json file
        with open(file_path, 'r') as input:
            data = json.load(input)

        # Check if 'behavior' key exists in the data
        if 'behavior' not in data or 'processes' not in data['behavior']:
            print(f"Skipping file {files} as it lacks 'behavior/processes' key.")
            continue  # Skip this file and continue with the next

        output_folder = os.path.join('./virusCSV', folders)
        if not os.path.exists(output_folder):
            os.makedirs(output_folder)
        #print(files.split('.')[0])
        files = files.split('.')[0]
        # Open a csv to write the info
        output_file = os.path.join(output_folder, f'{files}.csv')
        with open(output_file, 'w', newline='') as output:
            writer = csv.writer(output)
            # Write the title
            writer.writerow(['Category', 'API', 'Time'])

            for process in data['behavior']['processes']:
                for call in process['calls']:
                    # Get the info
                    category = call.get('category', 'N/A')
                    api = call.get('api', 'N/A')
                    call_time = call.get('time', 'N/A')
                    
                    # Write down in the csv
                    writer.writerow([category, api, call_time])

print("ALL CSV files have been created successfully.")